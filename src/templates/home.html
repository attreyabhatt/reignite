{% extends "base.html" %}
{% load static %}

{% block title %}Dead Chat? We Got You. | Reignite{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
    html,
    body {
        height: 100%;
    }

    body {
        font-family: 'Inter', sans-serif;
        background: #f9fafb;
        color: #212529;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .site-content {
        flex: 1 0 auto;
    }

    textarea,
    select,
    .form-control,
    .form-select {
        border-radius: 8px;
    }

    .btn-dark {
        padding: 0.6rem 1.5rem;
        border-radius: 8px;
    }

    #suggestedReply {
        font-size: 1rem;
    }

    .how-it-works {
        padding: 4rem 2rem;
        background: #ffffff;
    }

    .how-it-works h2 {
        font-weight: 700;
        text-align: center;
        margin-bottom: 2rem;
    }

    .how-it-works .step {
        text-align: center;
        margin-bottom: 2rem;
    }

    .why-section {
        background: #f0f2f5;
        padding: 4rem 2rem;
    }

    .why-section h3 {
        font-weight: 700;
        text-align: center;
        margin-bottom: 2rem;
    }

    .why-section ul {
        max-width: 700px;
        margin: 0 auto;
        list-style: none;
        padding-left: 0;
        font-size: 1.1rem;
    }

    .why-section li {
        margin-bottom: 1rem;
    }

    .why-section li::before {
        content: "üí¨";
        margin-right: 0.5rem;
    }

    .footer-cta {
        flex-shrink: 0;
        /* (Your existing footer styles go here) */
    }

    .footer-cta {
        text-align: center;
        padding: 3rem 2rem;
        font-size: 1.25rem;
        background: #212529;
        color: #fff;
    }

    h2,
    h3,
    h5 {
        font-weight: 600;
    }

    .shadow-sm {
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05) !important;
    }

    .rounded-4 {
        border-radius: 1rem;
    }

    .footer-cta {
        text-align: center;
        padding: 3rem 2rem;
        font-size: 1.5rem;
    }

    #form-container {
        display: flex;
        flex-direction: column;
        gap: 1em;
    }
</style>
{% endblock extra_head %}

{% block content %}
<div class="site-content">
    <!-- HERO WITH FORM -->
    <div class="container py-5">
        <div class="row">
            <!-- Text Pitch -->
            <div class="col-md-6 mb-4 mb-md-0">
                <div class="row">
                    <div class="col-12">
                        <h1 class="display-5 fw-bold">Dead Chat? We'll Revive It. üí¨</h1>
                        <p class="lead text-muted">She left you on read. You sent ‚Äúcool lol‚Äù. It‚Äôs not over yet. Paste
                            your
                            conversation and let our AI wingman craft your comeback.</p>
                    </div>
                </div>
                <div class="mt-2 text-center row align-items-center d-flex mt-2 text-center row justify-content-center" id="responseArea" style="display:none;">
                    <div class="col-md-4">
                        <div id="suggestedReply" class="p-4 bg-light rounded-4 shadow mb-2 w-100 me-2 position-relative" style="display: none;">
                            <button type="button" class="btn btn-link btn-sm position-absolute top-0 end-0 m-2"
                                onclick="copyToClipboard('suggestedReplyMsg', this)" title="Copy to clipboard">
                                <i class="fa fa-copy"></i>
                                <span class="copied-tooltip"
                                    style="display: none; position: absolute; top: 120%; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 2px 8px; border-radius: 8px; font-size: 12px; z-index: 2;">Copied!</span>
                            </button>

                            <span id="suggestedReplyMsg">No response has been generated yet</span>
                            <br>
                            <span class="small text-muted" id="suggestedReplyScore"></span>
                        </div>
                    </div>
                    <!-- Repeat similarly for suggestedReply2 and suggestedReply3, updating IDs -->

                    <div class="col-md-4">
                        <div id="suggestedReply2" class="p-4 bg-light rounded-4 shadow mb-2 w-100 me-2 position-relative" style="display: none;">
                            <button type="button" class="btn btn-link btn-sm position-absolute top-0 end-0 m-2"
                                onclick="copyToClipboard('suggestedReplyMsg2', this)" title="Copy to clipboard">
                                <i class="fa fa-copy"></i>
                                <span class="copied-tooltip"
                                    style="display: none; position: absolute; top: 120%; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 2px 8px; border-radius: 8px; font-size: 12px; z-index: 2;">Copied!</span>
                            </button>

                            <span id="suggestedReplyMsg2">No response has been generated yet</span>
                            <br>
                            <span class="small text-muted" id="suggestedReplyScore2"></span>
                        </div>
                    </div>
                    <!-- Repeat similarly for suggestedReply2 and suggestedReply3, updating IDs -->

                    <div class="col-md-4">
                        <div id="suggestedReply3" class="p-4 bg-light rounded-4 shadow mb-2 w-100 me-2 position-relative" style="display: none;">
                            <button type="button" class="btn btn-link btn-sm position-absolute top-0 end-0 m-2"
                                onclick="copyToClipboard('suggestedReplyMsg3', this)" title="Copy to clipboard">
                                <i class="fa fa-copy"></i>
                                <span class="copied-tooltip"
                                    style="display: none; position: absolute; top: 120%; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 2px 8px; border-radius: 8px; font-size: 12px; z-index: 2;">Copied!</span>
                            </button>

                            <span id="suggestedReplyMsg3">No response has been generated yet</span>
                            <br>
                            <span class="small text-muted" id="suggestedReplyScore3"></span>
                        </div>
                    </div>
                    <!-- Repeat similarly for suggestedReply2 and suggestedReply3, updating IDs -->

                </div>

                


            </div>

            <!-- Form -->
            <div class="col-6">
                <div class="form-container">
                    <form id="chatForm" class="rounded-4 shadow-lg bg-white p-4" style="min-width:350px;">
                        {% csrf_token %}
                        <!-- Step 1: Context Quick Pick -->
                        <div class="mb-4">
                            <div class="row g-2">
                                <div class="col-12 col-md-6">
                                    <label for="platform" class="form-label fw-semibold">
                                        <i class="fa fa-hashtag me-1 text-primary"></i> Platform
                                    </label>
                                    <select class="form-select rounded-pill" id="platform" name="platform">
                                        <option value="Tinder">Tinder</option>
                                        <option value="Bumble">Bumble</option>
                                        <option value="Hinge">Hinge</option>
                                        <option value="Instagram DM">Instagram DM</option>
                                        <option value="WhatsApp">WhatsApp</option>
                                        <option value="iMessage/SMS">iMessage/SMS</option>
                                        <option value="Snapchat">Snapchat</option>
                                        <option value="Telegram">Telegram</option>
                                        <option value="Facebook Messenger">Facebook Messenger</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="col-12 col-md-6">
                                    <label for="what-happened" class="form-label fw-semibold">
                                        <i class="fa fa-question-circle me-1 text-info"></i> What happened?
                                    </label>
                                    <select class="form-select rounded-pill" id="what-happened" name="what-happened">
                                        <option value="She left me on read">Left on read</option>
                                        <option value="She replied, but I need help with my next message">She replied,
                                            but I need help with my next message
                                        </option>
                                        <option value="She replied with one word, then nothing">She replied with one
                                            word/emoticon, then nothing</option>
                                        <option value="She didn‚Äôt reply after my question">No reply to my question
                                        </option>
                                        <option value="She ghosted after I asked her out">Ghosted after invite</option>
                                        <option value="Conversation just fizzled">Just fizzled out</option>
                                        <option value="She didn‚Äôt reply after my joke">No reply to my joke</option>
                                        <option value="She ignored my compliment">Ignored my compliment</option>
                                        <option value="I sent something awkward">Sent something awkward</option>
                                        <option value="No reply to my flirty message">No reply to my flirty message
                                        </option>
                                        <option value="Not sure / Just stopped">Not sure/just stopped</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <!-- Step 2: Main Details (Title and Screenshot, Collapsible for optional note) -->
                        <div class="mb-3 p-3 rounded-3" style="background: #f8f9fa;">

                            <label for="formFile" class="form-label mt-2 fw-semibold">
                                <i class="me-1 text-success"></i> Upload Screenshot
                                <span class="small text-muted">(optional ‚Äì for instant extracting messages)</span>
                            </label>
                            <input class="form-control rounded-pill mb-2" type="file" id="formFile">

                            <div class="form-text mb-2">
                                Drag & drop a chat screenshot, or paste your convo below.
                            </div>
                            <div id="ocr-status" class="mt-2" style="display:none;">
                                <span class="spinner-border spinner-border-sm align-middle text-primary"
                                    role="status"></span>
                                <span class="ms-2 text-muted">Analyzing screenshot...</span>
                            </div>
                        </div>
                        <!-- Step 3: Conversation Paste -->
                        <div class="mb-3">
                            <label for="last-reply" class="form-label fw-semibold">
                                <i class="me-1 text-warning"></i> Conversation
                            </label>
                            <textarea name="last-reply" id="last-reply" class="form-control" style="min-height:120px"
                                placeholder="you: hey, free thursday?&#10;her: (seen, no reply)"></textarea>
                        </div>

                        <!-- Step 5: Action Row -->
                        <div class="d-flex justify-content-between align-items-center">
                            <button type="submit" class="btn btn-dark btn-lg px-4 rounded-pill shadow-sm"
                                id="generate-btn">
                                <i class="fa fa-fire me-2"></i>Generate Reply
                            </button>

                            <div class="mt-2 small text-muted">
                                Chat Credits: <span id="chatCredits">{{ chat_credits }}</span>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- HOW IT WORKS -->
    <div class="py-5" style="background-color: #f0f2f5;">
        <div class="container">
            <h2 class="text-center fw-bold mb-5">Here‚Äôs the Game Plan</h2>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="p-4 bg-white rounded-4 shadow-sm h-100 text-center">
                        <div style="font-size: 2rem;">üìå</div>
                        <h5 class="mt-3 fw-semibold">Drop the last conversation</h5>
                        <p class="text-muted">Paste the last thing you or she said ‚Äî we‚Äôll take it from there.</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-4 bg-white rounded-4 shadow-sm h-100 text-center">
                        <div style="font-size: 2rem;">üß†</div>
                        <h5 class="mt-3 fw-semibold">We craft your comeback</h5>
                        <p class="text-muted">Witty, playful, sincere ‚Äî we shape it to match the vibe.</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-4 bg-white rounded-4 shadow-sm h-100 text-center">
                        <div style="font-size: 2rem;">üöÄ</div>
                        <h5 class="mt-3 fw-semibold">Send it & watch it work</h5>
                        <p class="text-muted">Slide back into the convo like you never left. Smooth.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- WHY SECTION -->
    <div class="pt-5" style="background-color: #ffffff;">
        <div class="container">
            <h3 class="text-center fw-bold mb-4">Let‚Äôs Be Real ‚Äî You‚Äôve Been Here:</h3>
            <div class="row justify-content-center g-4">
                <div class="col-md-5">
                    <div class="p-4 bg-light rounded-4 shadow-sm">
                        üí¨ You don‚Äôt know what to say after ‚Äúlol yeah‚Äù
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="p-4 bg-light rounded-4 shadow-sm">
                        üí¨ You‚Äôre new to dating apps and feel a little lost
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="p-4 bg-light rounded-4 shadow-sm">
                        üí¨ Your humor doesn‚Äôt always land over text
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="p-4 bg-light rounded-4 shadow-sm">
                        üí¨ You froze mid-convo and now it‚Äôs been 3 days
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- JS -->
<script>
    const csrfToken = '{{ csrf_token }}';

    document.getElementById('chatForm').addEventListener('submit', function (e) {
        e.preventDefault();

        document.getElementById('suggestedReplyMsg').innerHTML = `
            <span class="spinner-border spinner-border-sm align-middle text-primary" role="status"></span>
            <span class="ms-2 text-muted">Generating your texts‚Ä¶</span>
        `;

        document.getElementById('responseArea').style.display = 'block';
        var suggestedReply = document.getElementById("suggestedReply");
        suggestedReply.style.display = "block"
        let last_reply = document.getElementById('last-reply').value;
        let platform = document.getElementById('platform').value;
        let what_happened = document.getElementById('what-happened').value;

        fetch("{% url 'ajax_reply_home' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                last_text: last_reply,
                platform: platform,
                what_happened: what_happened
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.redirect_url) {
                    window.location.href = data.redirect_url + '?next=/&message=out_of_credits';
                    return;
                }



                // --- CUSTOM AI RESPONSE HANDLING ---
                let customResponse = data.custom;

                // Remove "json" prefix (case-insensitive), and trim
                customResponse = customResponse.replace(/^json\s*/i, '').trim();

                // Now, customResponse should start with '[' and end with ']'
                if (!customResponse.startsWith('[')) {
                    // Try to extract JSON array with regex as fallback
                    const match = customResponse.match(/\[.*\]/s);
                    if (match) {
                        customResponse = match[0];
                    }
                }

                // Try to parse, and handle any errors
                let suggestions;
                try {
                    suggestions = JSON.parse(customResponse);
                    // Now you can safely use the array
                } catch (e) {
                    alert('Parse error: ' + e.message);
                    console.error('Could not parse:', customResponse, e);
                    // Fallback: Show the raw string
                    document.getElementById('suggestedReply').innerHTML = `<span>${customResponse}</span>`;
                    document.getElementById('suggestedReply2').style.display = "none";
                    document.getElementById('suggestedReply3').style.display = "none";
                    return;
                }


                if (Array.isArray(suggestions) && suggestions.length > 0) {
                    // Reply 1
                    
                    const msg1 = document.getElementById('suggestedReplyMsg');
                    const score1 = document.getElementById('suggestedReplyScore');
                    if (msg1) msg1.innerText = suggestions[0].message;
                    if (score1) score1.innerText = `Confidence: ${Math.round(suggestions[0].confidence_score * 100)}%`;

                    // Reply 2
                    if (suggestions[1]) {
                        document.getElementById('suggestedReply2').style.display = "block";
                        const msg2 = document.getElementById('suggestedReplyMsg2');
                        const score2 = document.getElementById('suggestedReplyScore2');
                        if (msg2) msg2.innerText = suggestions[1].message;
                        if (score2) score2.innerText = `Confidence: ${Math.round(suggestions[1].confidence_score * 100)}%`;
                    } else {
                        document.getElementById('suggestedReply2').style.display = "none";
                    }

                    // Reply 3
                    if (suggestions[2]) {
                        document.getElementById('suggestedReply3').style.display = "block";
                        const msg3 = document.getElementById('suggestedReplyMsg3');
                        const score3 = document.getElementById('suggestedReplyScore3');
                        if (msg3) msg3.innerText = suggestions[2].message;
                        if (score3) score3.innerText = `Confidence: ${Math.round(suggestions[2].confidence_score * 100)}%`;
                    } else {
                        document.getElementById('suggestedReply3').style.display = "none";
                    }
                } else {
                    document.getElementById('suggestedReply').innerHTML = `<span>No suggestions available.</span>`;
                    document.getElementById('suggestedReply2').style.display = "none";
                    document.getElementById('suggestedReply3').style.display = "none";
                }


                document.getElementById('chatCredits').innerText = "Chat Credits: " + data.credits_left;
                document.getElementById('chatCredits').innerText = data.credits_left;

            })
            .catch(error => {
                alert("Error generating reply.");
                console.error(error);
            });
    });
</script>

<!-- Screenshot ocr -->
<script>
    const fileInput = document.getElementById('formFile').addEventListener('change', function (e) {
        const fileInput = e.target;
        const file = fileInput.files[0];
        if (!file) return;

        // Show spinner/status
        document.getElementById('ocr-status').style.display = 'inline-flex';

        const formData = new FormData();
        formData.append('screenshot', file);

        fetch("/conversations/ocr-screenshot/", {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('ocr-status').style.display = 'none'; // Hide spinner/status
                if (data.ocr_text) {
                    const lastReply = document.getElementById('last-reply');
                    if (lastReply.value.trim()) {
                        lastReply.value = lastReply.value.trim() + "\n\n" + data.ocr_text;
                    } else {
                        lastReply.value = data.ocr_text;
                    }
                } else {
                    alert(data.error || "Failed to extract text from image.");
                }
                fileInput.value = '';
            })
            .catch(() => {
                document.getElementById('ocr-status').style.display = 'none'; // Hide spinner/status
                alert("Failed to OCR the screenshot.");
                fileInput.value = '';
            });
    });


</script>

<!-- copied -->
<script>
    function copyToClipboard(elementId, btn) {
            const text = document.getElementById(elementId).innerText;
            navigator.clipboard.writeText(text).then(function () {
                // Show the "Copied!" tooltip
                const tooltip = btn.querySelector('.copied-tooltip');
                if (tooltip) {
                    tooltip.style.display = 'inline-block';
                    setTimeout(() => {
                        tooltip.style.display = 'none';
                    }, 1000); // 1 second
                }
            });
        }


</script>

{% endblock %}