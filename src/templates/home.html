{% extends "base.html" %}
{% load static %}

{% block title %}Dead Chat? We Got You. | Reignite{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
    html,
    body {
        height: 100%;
    }

    body {
        font-family: 'Inter', sans-serif;
        background: #f9fafb;
        color: #212529;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .site-content {
        flex: 1 0 auto;
    }

    textarea,
    select,
    .form-control,
    .form-select {
        border-radius: 8px;
    }

    .btn-dark {
        padding: 0.6rem 1.5rem;
        border-radius: 8px;
    }

    #suggestedReply {
        font-size: 1rem;
    }

    .how-it-works {
        padding: 4rem 2rem;
        background: #ffffff;
    }

    .how-it-works h2 {
        font-weight: 700;
        text-align: center;
        margin-bottom: 2rem;
    }

    .how-it-works .step {
        text-align: center;
        margin-bottom: 2rem;
    }

    .why-section {
        background: #f0f2f5;
        padding: 4rem 2rem;
    }

    .why-section h3 {
        font-weight: 700;
        text-align: center;
        margin-bottom: 2rem;
    }

    .why-section ul {
        max-width: 700px;
        margin: 0 auto;
        list-style: none;
        padding-left: 0;
        font-size: 1.1rem;
    }

    .why-section li {
        margin-bottom: 1rem;
    }

    .why-section li::before {
        content: "üí¨";
        margin-right: 0.5rem;
    }

    .footer-cta {
        flex-shrink: 0;
        /* (Your existing footer styles go here) */
    }

    .footer-cta {
        text-align: center;
        padding: 3rem 2rem;
        font-size: 1.25rem;
        background: #212529;
        color: #fff;
    }

    h2,
    h3,
    h5 {
        font-weight: 600;
    }

    .shadow-sm {
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05) !important;
    }

    .rounded-4 {
        border-radius: 1rem;
    }

    .footer-cta {
        text-align: center;
        padding: 3rem 2rem;
        font-size: 1.5rem;
    }

    #form-container {
        display: flex;
        flex-direction: column;
        gap: 1em;
    }
</style>
{% endblock extra_head %}

{% block content %}
<div class="site-content">
    <!-- HERO WITH FORM -->
    <div class="container py-5">
        <div class="row">
            <!-- Text Pitch -->
            <div class="col-md-6 col-sm-12 mb-4 mb-md-0">
                <div class="row">
                    <div class="col-12">
                        <h1 class="display-5 fw-bold">Dead Chat? We'll Revive It. üí¨</h1>
                        <p class="lead text-muted">She left you on read. You sent ‚Äúcool lol‚Äù. It‚Äôs not over yet. Paste
                            your
                            conversation and let our AI wingman craft your comeback.</p>
                    </div>
                </div>
                <div class="mt-2 text-center row align-items-center d-flex mt-2 text-center row justify-content-center"
                    id="responseArea" style="display:none;">
                    <div class="col-md-4 col-sm-12">
                        <div id="suggestedReply" class="p-4 bg-light rounded-4 shadow mb-2 w-100 me-2 position-relative"
                            style="display: none;">
                            <button type="button" class="btn btn-link btn-sm position-absolute top-0 end-0 m-2 copy-btn"
                                onclick="copyToClipboard('suggestedReplyMsg', this)" title="Copy to clipboard">
                                <i class="fa fa-copy"></i>
                                <span class="copied-tooltip"
                                    style="display: none; position: absolute; top: 120%; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 2px 8px; border-radius: 8px; font-size: 12px; z-index: 2;">Copied!</span>
                            </button>

                            <span id="suggestedReplyMsg">No response has been generated yet</span>
                            <br>
                            <span class="small text-muted" id="suggestedReplyScore"></span>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-12">
                        <div id="suggestedReply2"
                            class="p-4 bg-light rounded-4 shadow mb-2 w-100 me-2 position-relative"
                            style="display: none;">
                            <button type="button" class="btn btn-link btn-sm position-absolute top-0 end-0 m-2 copy-btn"
                                onclick="copyToClipboard('suggestedReplyMsg2', this)" title="Copy to clipboard">
                                <i class="fa fa-copy"></i>
                                <span class="copied-tooltip"
                                    style="display: none; position: absolute; top: 120%; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 2px 8px; border-radius: 8px; font-size: 12px; z-index: 2;">Copied!</span>
                            </button>

                            <span id="suggestedReplyMsg2">No response has been generated yet</span>
                            <br>
                            <span class="small text-muted" id="suggestedReplyScore2"></span>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-12">
                        <div id="suggestedReply3"
                            class="p-4 bg-light rounded-4 shadow mb-2 w-100 me-2 position-relative"
                            style="display: none;">
                            <button type="button" class="btn btn-link btn-sm position-absolute top-0 end-0 m-2 copy-btn"
                                onclick="copyToClipboard('suggestedReplyMsg3', this)" title="Copy to clipboard">
                                <i class="fa fa-copy"></i>
                                <span class="copied-tooltip"
                                    style="display: none; position: absolute; top: 120%; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 2px 8px; border-radius: 8px; font-size: 12px; z-index: 2;">Copied!</span>
                            </button>

                            <span id="suggestedReplyMsg3">No response has been generated yet</span>
                            <br>
                            <span class="small text-muted" id="suggestedReplyScore3"></span>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Form -->
            <div class="col-md-6 col-sm-12">
                <div class="form-container">
                    <form id="chatForm" class="rounded-4 shadow-lg bg-white p-4" style="min-width:350px;">
                        {% csrf_token %}
                        <!-- Step 1: Context Quick Pick -->
                        <div class="mb-4">
                            <div class="row g-2">
                                <div class="col-12 col-md-6">
                                    <label for="platform" class="form-label fw-semibold">
                                        <i class="fa fa-hashtag me-1 text-primary"></i> Platform
                                    </label>
                                    <select class="form-select rounded-pill" id="platform" name="platform">
                                        <option value="Tinder">Tinder</option>
                                        <option value="Bumble">Bumble</option>
                                        <option value="Hinge">Hinge</option>
                                        <option value="Instagram DM">Instagram DM</option>
                                        <option value="WhatsApp">WhatsApp</option>
                                        <option value="iMessage/SMS">iMessage/SMS</option>
                                        <option value="Snapchat">Snapchat</option>
                                        <option value="Telegram">Telegram</option>
                                        <option value="Facebook Messenger">Facebook Messenger</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="col-12 col-md-6">
                                    <label for="what-happened" class="form-label fw-semibold">
                                        <i class="fa fa-question-circle me-1 text-info"></i> What happened?
                                    </label>
                                    <select class="form-select rounded-pill" id="what-happened" name="what-happened">
                                        <option value="She left me on read">Left on read</option>
                                        <option value="She replied, but I need help with my next message">She replied,
                                            but I need help with my next message
                                        </option>
                                        <option value="She replied with one word, then nothing">She replied with one
                                            word/emoticon, then nothing</option>
                                        <option value="She didn‚Äôt reply after my question">No reply to my question
                                        </option>
                                        <option value="She ghosted after I asked her out">Ghosted after invite</option>
                                        <option value="Conversation just fizzled">Just fizzled out</option>
                                        <option value="She didn‚Äôt reply after my joke">No reply to my joke</option>
                                        <option value="She ignored my compliment">Ignored my compliment</option>
                                        <option value="I sent something awkward">Sent something awkward</option>
                                        <option value="No reply to my flirty message">No reply to my flirty message
                                        </option>
                                        <option value="Not sure / Just stopped">Not sure/just stopped</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <!-- Step 2: Main Details (Title and Screenshot, Collapsible for optional note) -->
                        <div class="mb-3 p-3 rounded-3" style="background: #f8f9fa;">

                            <label for="formFile" class="form-label mt-2 fw-semibold">
                                <i class="me-1 text-success"></i> Upload Screenshot
                                <span class="small text-muted">(optional ‚Äì for instant extracting messages)</span>
                            </label>
                            <input class="form-control rounded-pill mb-2" type="file" id="formFile">

                            <div class="form-text mb-2">
                                Drag & drop a chat screenshot, or paste your convo below.
                            </div>
                            <div id="ocr-status" class="mt-2" style="display:none;">
                                <span class="spinner-border spinner-border-sm align-middle text-primary"
                                    role="status"></span>
                                <span class="ms-2 text-muted">Analyzing screenshot...</span>
                            </div>
                        </div>
                        <!-- Step 3: Conversation Paste -->
                        <div class="mb-3">
                            <label for="last-reply" class="form-label fw-semibold">
                                <i class="me-1 text-warning"></i> Conversation
                            </label>
                            <textarea name="last-reply" id="last-reply" class="form-control" style="min-height:120px"
                                placeholder="you: hey, free thursday?&#10;her: (seen, no reply)"></textarea>
                        </div>

                        <!-- Step 5: Action Row -->
                        <div class="d-flex justify-content-between align-items-center">
                            <button type="submit" class="btn btn-dark btn-lg px-4 rounded-pill shadow-sm"
                                id="generate-btn">
                                <i class="fa fa-fire me-2"></i>Generate Reply
                            </button>

                            <div class="mt-2 small text-muted">
                                Chat Credits: <span id="chatCredits">{{ chat_credits }}</span>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- HOW IT WORKS -->
    <div class="py-5" style="background-color: #f0f2f5;">
        <div class="container">
            <h2 class="text-center fw-bold mb-5">Here‚Äôs the Game Plan</h2>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="p-4 bg-white rounded-4 shadow-sm h-100 text-center">
                        <div style="font-size: 2rem;">üìå</div>
                        <h5 class="mt-3 fw-semibold">Drop the last conversation</h5>
                        <p class="text-muted">Paste the last thing you or she said ‚Äî we‚Äôll take it from there.</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-4 bg-white rounded-4 shadow-sm h-100 text-center">
                        <div style="font-size: 2rem;">üß†</div>
                        <h5 class="mt-3 fw-semibold">We craft your comeback</h5>
                        <p class="text-muted">Witty, playful, sincere ‚Äî we shape it to match the vibe.</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-4 bg-white rounded-4 shadow-sm h-100 text-center">
                        <div style="font-size: 2rem;">üöÄ</div>
                        <h5 class="mt-3 fw-semibold">Send it & watch it work</h5>
                        <p class="text-muted">Slide back into the convo like you never left. Smooth.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- WHY SECTION -->
    <div class="pt-5" style="background-color: #ffffff;">
        <div class="container">
            <h3 class="text-center fw-bold mb-4">Let‚Äôs Be Real ‚Äî You‚Äôve Been Here:</h3>
            <div class="row justify-content-center g-4">
                <div class="col-md-5">
                    <div class="p-4 bg-light rounded-4 shadow-sm">
                        üí¨ You don‚Äôt know what to say after ‚Äúlol yeah‚Äù
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="p-4 bg-light rounded-4 shadow-sm">
                        üí¨ You‚Äôre new to dating apps and feel a little lost
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="p-4 bg-light rounded-4 shadow-sm">
                        üí¨ Your humor doesn‚Äôt always land over text
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="p-4 bg-light rounded-4 shadow-sm">
                        üí¨ You froze mid-convo and now it‚Äôs been 3 days
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- JS -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Pull CSRF from the hidden input rendered by {% csrf_token %}
        const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]')?.value || '';

        // Cache DOM
        const form = document.getElementById('chatForm');
        const generateBtn = document.getElementById('generate-btn');

        const responseArea = document.getElementById('responseArea');
        const card1 = document.getElementById('suggestedReply');
        const card2 = document.getElementById('suggestedReply2');
        const card3 = document.getElementById('suggestedReply3');

        const msg1 = document.getElementById('suggestedReplyMsg');
        const score1 = document.getElementById('suggestedReplyScore');
        const msg2 = document.getElementById('suggestedReplyMsg2');
        const score2 = document.getElementById('suggestedReplyScore2');
        const msg3 = document.getElementById('suggestedReplyMsg3');
        const score3 = document.getElementById('suggestedReplyScore3');

        // Keep everything hidden on load (matches your markup)
        if (responseArea) responseArea.style.display = 'none';
        if (card1) card1.style.display = 'none';
        if (card2) card2.style.display = 'none';
        if (card3) card3.style.display = 'none';

        form.addEventListener('submit', function (e) {
            e.preventDefault();

            // Disable button + inline spinner
            const oldBtnHTML = generateBtn.innerHTML;
            generateBtn.disabled = true;
            generateBtn.innerHTML = `<span class="spinner-border spinner-border-sm align-middle" role="status"></span>
                               <span class="ms-2">Generating‚Ä¶</span>`;

            // Show ONLY Card #1 with "Generating your texts‚Ä¶" right away
            if (responseArea) responseArea.style.display = 'block';
            if (card1) card1.style.display = 'block';
            if (card2) card2.style.display = 'none';
            if (card3) card3.style.display = 'none';

            if (msg1) {
                msg1.innerHTML = `
          <span class="spinner-border spinner-border-sm align-middle text-primary" role="status"></span>
          <span class="ms-2 text-muted">Generating your texts‚Ä¶</span>
        `;
            }
            if (score1) score1.innerText = '';

            // Gather inputs
            const last_reply = document.getElementById('last-reply').value;
            const platform = document.getElementById('platform').value;
            const what_happened = document.getElementById('what-happened').value;

            window.scrollTo({ top: 0, behavior: 'smooth' });

            fetch("{% url 'ajax_reply_home' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    last_text: last_reply,
                    platform: platform,
                    what_happened: what_happened
                })
            })
                .then(async (response) => {
                    const data = await response.json().catch(() => null);

                    // Out-of-credits path your backend returns
                    if (data && data.redirect_url) {
                        window.location.href = data.redirect_url + '?next=/&message=out_of_credits';
                        throw 'redirected';
                    }

                    // Show server-provided error (views return 'error' for bad requests/AI failure)
                    if (!response.ok || (data && data.error)) {
                        const msg = (data && data.error) ? data.error : `Error ${response.status}`;
                        throw new Error(msg);
                    }
                    return data;
                })
                .then((data) => {
                    // Parse the custom suggestions payload your view returns (custom + credits_left)
                    // views.py sends: {'custom': <string>, 'credits_left': <int>, ...} :contentReference[oaicite:3]{index=3}
                    let customResponse = data.custom;
                    if (typeof customResponse !== 'string') {
                        throw new Error('Unexpected response format from server.');
                    }

                    // Remove possible "json" prefix and try to coerce to a JSON array
                    customResponse = customResponse.replace(/^json\s*/i, '').trim();
                    if (!customResponse.startsWith('[')) {
                        const match = customResponse.match(/\[.*\]/s);
                        if (match) customResponse = match[0];
                    }

                    let suggestions;
                    try {
                        suggestions = JSON.parse(customResponse);
                    } catch (e) {
                        throw new Error('Could not parse AI response. ' + e.message);
                    }

                    // After success: SHOW ALL THREE CARDS (as requested), fill with fallbacks if missing
                    if (responseArea) responseArea.style.display = 'block';
                    card1.style.display = 'block';
                    card2.style.display = 'block';
                    card3.style.display = 'block';

                    const s1 = suggestions?.[0] || {};
                    const s2 = suggestions?.[1] || {};
                    const s3 = suggestions?.[2] || {};

                    msg1.innerText = s1.message || '‚Äî';
                    score1.innerText = (typeof s1.confidence_score === 'number')
                        ? `Confidence: ${Math.round(s1.confidence_score * 100)}%`
                        : '';

                    msg2.innerText = s2.message || '‚Äî';
                    score2.innerText = (typeof s2.confidence_score === 'number')
                        ? `Confidence: ${Math.round(s2.confidence_score * 100)}%`
                        : '';

                    msg3.innerText = s3.message || '‚Äî';
                    score3.innerText = (typeof s3.confidence_score === 'number')
                        ? `Confidence: ${Math.round(s3.confidence_score * 100)}%`
                        : '';

                    // Update credits (your span is already next to ‚ÄúChat Credits:‚Äù)
                    if (typeof data.credits_left !== 'undefined') {
                        document.getElementById('chatCredits').innerText = data.credits_left;
                    }
                })
                .catch((err) => {
                    if (err === 'redirected') return;

                    // Show the precise error text from the server (e.g., AI fail / invalid / unauthorized)
                    alert(err?.message || 'Error generating reply.');

                    // Revert to pre-submit look: keep only Card #1 visible with default copy
                    if (msg1) msg1.innerText = 'No response has been generated yet';
                    if (score1) score1.innerText = '';
                    card2.style.display = 'none';
                    card3.style.display = 'none';
                    // Optionally hide the whole area on error ‚Äî comment the next line if you prefer to keep it visible
                    // responseArea.style.display = 'none';
                })
                .finally(() => {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = oldBtnHTML;
                });
        });

        // Screenshot OCR (left intact, just uses the same CSRF + better error surfacing)
        document.getElementById('formFile').addEventListener('change', function (e) {
            const inputEl = e.target;
            const file = inputEl.files?.[0];
            if (!file) return;

            const ocrStatus = document.getElementById('ocr-status');
            if (ocrStatus) ocrStatus.style.display = 'inline-flex';

            const formData = new FormData();
            formData.append('screenshot', file);

            fetch("/conversations/ocr-screenshot/", {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            })
                .then(async (response) => {
                    const data = await response.json().catch(() => null);
                    if (!response.ok || (data && data.error)) {
                        // Same redirect/error pattern as your backend provides for OCR too :contentReference[oaicite:4]{index=4}
                        if (data && data.redirect_url) {
                            window.location.href = data.redirect_url;
                            throw 'redirected';
                        }
                        const msg = (data && data.error) ? data.error : `OCR failed (status ${response.status})`;
                        throw new Error(msg);
                    }
                    return data;
                })
                .then((data) => {
                    if (ocrStatus) ocrStatus.style.display = 'none';
                    if (data.ocr_text) {
                        const lastReply = document.getElementById('last-reply');
                        if (lastReply.value.trim()) {
                            lastReply.value = lastReply.value.trim() + "\n\n" + data.ocr_text;
                        } else {
                            lastReply.value = data.ocr_text;
                        }
                    } else {
                        throw new Error("Failed to extract text from image.");
                    }
                })
                .catch((err) => {
                    if (err === 'redirected') return;
                    if (ocrStatus) ocrStatus.style.display = 'none';
                    alert(err?.message || "Failed to OCR the screenshot.");
                })
                .finally(() => {
                    inputEl.value = '';
                });
        });

        // Copy helper (same as yours)
        window.copyToClipboard = function (elementId, btn) {
            const text = document.getElementById(elementId).innerText;
            navigator.clipboard.writeText(text).then(function () {
                const tooltip = btn.querySelector('.copied-tooltip');
                if (tooltip) {
                    tooltip.style.display = 'inline-block';
                    setTimeout(() => { tooltip.style.display = 'none'; }, 1000);
                }
            });
        };
    });
</script>



{% endblock %}