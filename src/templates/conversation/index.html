{% extends "base.html" %}
{% load static %}

{% block title %}Dead Chat? We Got You. | Reignite{% endblock %}

{% block extra_head %}
<style>
    .list-group-item.active,
    .list-group-item:hover {
        background: #e7f3ff !important;
    }
</style>
{% endblock extra_head %}

{% block content %}
<div class="container px-3">
    <div class="row gy-4 flex-column-reverse flex-lg-row">

        <!-- Sidebar: Conversation List -->
        <div class="col-12 col-lg-3">
            {% if conversations %}
            <ul class="list-group">
                {% for conversation in conversations %}
                <a href="#" class="list-group-item list-group-item-action list-group-item-light convo-link"
                    data-id="{{ conversation.id }}">
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <span>{{ conversation.girl_title }}</span>
                        <button class="btn btn-sm btn-link text-danger delete-convo-btn" data-id="{{ conversation.id }}"
                            title="Delete">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                </a>
                {% endfor %}
            </ul>
            {% endif %}
            <div class="mt-3">
                <a href="{% url 'conversation_home'%}" class="btn btn-outline-dark w-100" role="button">
                    <i class="fa fa-plus me-1"></i>Add a new conversation
                </a>
            </div>
        </div>

        <!-- Main Form -->
        <div class="col-12 col-lg-6">
            <div class="form-container">
                <form id="chatForm" class="rounded-4 shadow-lg bg-white p-4 w-100">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="situation" class="form-label fw-semibold">
                            <i class="fa fa-bullseye me-1 text-primary"></i> What's the situation?
                        </label>
                        <select class="form-select rounded-pill" id="situation" name="situation" required>
                            <option value="stuck_after_reply" selected>She replied, but I don‚Äôt know what to say</option>
                            
                            <optgroup label="üü¢ Early-Conversation">
                                <option value="just_matched">We just matched</option>
                                <option value="spark_interest">I want to spark her interest</option>
                            </optgroup>
                        
                            <optgroup label="üü° Mid-Conversation">
                                <option value="stuck_after_reply">She replied, but I don‚Äôt know what to say</option>
                                <option value="dry_reply">She gave a dry or one-word reply</option>
                                <option value="she_asked_question">She asked me a question</option>
                                <option value="feels_like_interview">Conversation feels like an interview</option>
                                <option value="sassy_challenge">She is being sassy or challenging</option>
                                <option value="spark_deeper_conversation">Be sincere and vulnerable</option>
                                <option value="pivot_conversation">Change the subject</option>
                            </optgroup>
                        
                            <optgroup label="üîÅ Recovery or Reigniting">
                                <option value="left_on_read">She left me on read</option>
                                <option value="reviving_old_chat">I haven‚Äôt talked to her in a while</option>
                                <option value="recovering_after_cringe">I think I said something off</option>
                            </optgroup>
                        
                            <optgroup label="üü£ Late-Conversation">
                                <option value="ask_her_out">Ask her out</option>
                                <option value="switching_platforms">Trying to move to another platform</option>
                            </optgroup>
                        
                        </select>

                    </div>


                    <div class="mb-3">
                        <label for="her-info" class="form-label fw-semibold">
                            <i class="fa-solid fa-user-secret me-1 text-secondary"></i> Her Information (optional)
                        </label>
                        <textarea name="her-info" id="her_info" class="form-control" rows="3"
                            placeholder="Add anything that might help ‚Äî her bio, hobbies, vibe, or her hair style." value=""></textarea>
                        <div class="form-text">
                            Users who add information get 10X responses for their matches.
                        </div>
                    </div>


                    <!-- Title and Screenshot Upload -->
                    <div class="mb-3 p-3 rounded-3" style="background: #f8f9fa;">
                        <label for="formFile" class="form-label mt-2 fw-semibold">
                            <i class="me-1 text-success"></i> Upload Screenshot
                            <span class="small text-muted">(optional ‚Äì for instant extracting messages)</span>
                        </label>
                        <input class="form-control rounded-pill mb-2" type="file" id="formFile">

                        <div class="form-text mb-2">
                            Drag & drop a chat screenshot, or paste your convo below.
                        </div>
                        <div id="ocr-status" class="mt-2" style="display:none;">
                            <span class="spinner-border spinner-border-sm align-middle text-primary"
                                role="status"></span>
                            <span class="ms-2 text-muted">Analyzing screenshot...</span>
                        </div>
                    </div>

                    <!-- Conversation Paste Area -->
                    <div class="mb-3">
                        <label for="last-reply" class="form-label fw-semibold">
                            <i class="me-1 text-warning"></i> Conversation
                        </label>
                        <textarea name="last-reply" id="last-reply" class="form-control" style="min-height:120px"
                            placeholder="you: hey, free thursday?&#10;her: (seen, no reply)" rows="5"></textarea>
                        <div class="form-text text-end"><span id="charCount">0</span> characters</div>
                    </div>

                    <!-- Submit -->
                    <div class="d-flex justify-content-between align-items-center">
                        <button type="submit" class="btn btn-dark btn-lg px-4 rounded-pill shadow-sm" id="generate-btn">
                            <i class="fa fa-fire me-2"></i>Generate Reply
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Suggested Responses -->
        <div class="col-12 col-lg-3 text-center" id="responseArea">
            <p>Suggested Responses</p>

            <div id="suggestedReply" class="p-4 bg-light rounded-4 shadow w-100 position-relative mb-3">
                <button type="button" class="btn btn-link btn-sm position-absolute top-0 end-0 m-2"
                    onclick="copyToClipboard('suggestedReplyMsg', this)" title="Copy to clipboard">
                    <i class="fa fa-copy"></i>
                    <span class="copied-tooltip"
                        style="display: none; position: absolute; top: 120%; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 2px 8px; border-radius: 8px; font-size: 12px; z-index: 2;">Copied!</span>
                </button>
                <span id="suggestedReplyMsg">No response has been generated yet</span><br>
                <span class="small text-muted" id="suggestedReplyScore"></span>
            </div>

            <div id="suggestedReply2" class="p-4 bg-light rounded-4 shadow w-100 position-relative mb-3"
                style="display: none;">
                <button type="button" class="btn btn-link btn-sm position-absolute top-0 end-0 m-2"
                    onclick="copyToClipboard('suggestedReplyMsg2', this)" title="Copy to clipboard">
                    <i class="fa fa-copy"></i>
                    <span class="copied-tooltip"
                        style="display: none; position: absolute; top: 120%; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 2px 8px; border-radius: 8px; font-size: 12px; z-index: 2;">Copied!</span>
                </button>
                <span id="suggestedReplyMsg2">No response has been generated yet</span><br>
                <span class="small text-muted" id="suggestedReplyScore2"></span>
            </div>

            <div id="suggestedReply3" class="p-4 bg-light rounded-4 shadow w-100 position-relative mb-3"
                style="display: none;">
                <button type="button" class="btn btn-link btn-sm position-absolute top-0 end-0 m-2"
                    onclick="copyToClipboard('suggestedReplyMsg3', this)" title="Copy to clipboard">
                    <i class="fa fa-copy"></i>
                    <span class="copied-tooltip"
                        style="display: none; position: absolute; top: 120%; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 2px 8px; border-radius: 8px; font-size: 12px; z-index: 2;">Copied!</span>
                </button>
                <span id="suggestedReplyMsg3">No response has been generated yet</span><br>
                <span class="small text-muted" id="suggestedReplyScore3"></span>
            </div>
        </div>
    </div>
</div>
<!-- Payment Toast Notification -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1055">
    <div id="paymentToast" class="toast align-items-center text-white bg-success border-0" role="alert"
        aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="paymentToastMessage">
                Payment succeeded!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Close"></button>
        </div>
    </div>
</div>


<!-- JS -->

<script>

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Handle form submission for generating a reply
    document.getElementById('chatForm').addEventListener('submit', function (e) {

        e.preventDefault();
        document.getElementById('suggestedReplyMsg').innerHTML = `
            <span class="spinner-border spinner-border-sm align-middle text-primary" role="status"></span>
            <span class="ms-2 text-muted">Generating your texts‚Ä¶</span>
        `;

        let girl_title = ""; // will be auto-generated
        let last_reply = document.getElementById('last-reply').value;
        let situation = document.getElementById('situation').value;
        let her_info = document.getElementById('her_info').value;

        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });

        fetch("{% url 'ajax_reply' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                last_text: last_reply,
                girl_title: girl_title,
                situation: situation,
                her_info: her_info
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                    return;
                }
                document.getElementById('responseArea').style.display = 'block';

                // --- CUSTOM AI RESPONSE HANDLING ---
                let customResponse = data.custom;

                // Remove "json" prefix (case-insensitive), and trim
                customResponse = customResponse.replace(/^json\s*/i, '').trim();

                // Now, customResponse should start with '[' and end with ']'
                if (!customResponse.startsWith('[')) {
                    // Try to extract JSON array with regex as fallback
                    const match = customResponse.match(/\[.*\]/s);
                    if (match) {
                        customResponse = match[0];
                    }
                }

                // Try to parse, and handle any errors
                let suggestions;
                try {
                    suggestions = JSON.parse(customResponse);
                    console.log(suggestions)
                    // Now you can safely use the array
                } catch (e) {
                    alert('Parse error: ' + e.message);
                    console.error('Could not parse:', customResponse, e);
                    // Fallback: Show the raw string
                    document.getElementById('suggestedReply').innerHTML = `<span>${customResponse}</span>`;
                    document.getElementById('suggestedReply2').style.display = "none";
                    document.getElementById('suggestedReply3').style.display = "none";
                    return;
                }


                if (Array.isArray(suggestions) && suggestions.length > 0) {
                    // Reply 1

                    const msg1 = document.getElementById('suggestedReplyMsg');
                    const score1 = document.getElementById('suggestedReplyScore');
                    if (msg1) msg1.innerText = suggestions[0].message;
                    if (score1) score1.innerText = `Confidence: ${Math.round(suggestions[0].confidence_score * 100)}%`;
                    document.getElementById('suggestedReplyScore').style.display = "block";

                    // Reply 2
                    if (suggestions[1]) {
                        document.getElementById('suggestedReply2').style.display = "block";
                        const msg2 = document.getElementById('suggestedReplyMsg2');
                        const score2 = document.getElementById('suggestedReplyScore2');
                        if (msg2) msg2.innerText = suggestions[1].message;
                        if (score2) score2.innerText = `Confidence: ${Math.round(suggestions[1].confidence_score * 100)}%`;
                    } else {
                        document.getElementById('suggestedReply2').style.display = "none";
                    }

                    // Reply 3
                    if (suggestions[2]) {
                        document.getElementById('suggestedReply3').style.display = "block";
                        const msg3 = document.getElementById('suggestedReplyMsg3');
                        const score3 = document.getElementById('suggestedReplyScore3');
                        if (msg3) msg3.innerText = suggestions[2].message;
                        if (score3) score3.innerText = `Confidence: ${Math.round(suggestions[2].confidence_score * 100)}%`;
                    } else {
                        document.getElementById('suggestedReply3').style.display = "none";
                    }
                } else {
                    document.getElementById('suggestedReply').innerHTML = `<span>No suggestions available.</span>`;
                    document.getElementById('suggestedReply2').style.display = "none";
                    document.getElementById('suggestedReply3').style.display = "none";
                }

                document.getElementById('chatCredits').innerText = "Chat Credits: " + data.credits_left;

                // If a new conversation was created, add it to the sidebar instantly
                if (data.new_conversation) {
                    const ul = document.querySelector('.list-group');
                    if (ul) {
                        // Create a new <a> element with inner HTML (matches Django template)
                        const a = document.createElement('a');
                        a.href = "#";
                        a.className = "list-group-item list-group-item-action list-group-item-light convo-link";
                        a.setAttribute('data-id', data.new_conversation.id);

                        // Inner HTML with delete button
                        a.innerHTML = `
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <span>${data.new_conversation.girl_title}</span>
                                <button class="btn btn-sm btn-link text-danger delete-convo-btn" data-id="${data.new_conversation.id}" title="Delete">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        `;

                        // Add click handler for loading the conversation
                        a.addEventListener('click', function (e) {
                            // Prevent delete button from triggering this event!
                            if (e.target.closest('.delete-convo-btn')) return;

                            e.preventDefault();
                            const convoId = this.getAttribute('data-id');
                            fetch(`/conversations/detail/${convoId}/`, {
                                headers: {
                                    'X-CSRFToken': csrfToken
                                }
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.error) {
                                        alert('Could not load conversation.');
                                        return;
                                    }
                                    alert(data.her_info);
                                    document.getElementById('last-reply').value = data.content;
                                    document.getElementById('situation').value = data.situation || 'just_matched';
                                    document.getElementById('her_info').value = data.her_info ;
                                    document.getElementById('suggestedReplyMsg').innerHTML = 'No response has been generated yet';
                                    document.getElementById("suggestedReply2").style.display = "none";
                                    document.getElementById("suggestedReply3").style.display = "none";


                                })
                                .catch(() => alert('Failed to load conversation.'));
                        });

                        // Add new conversation link at the top of the sidebar
                        ul.insertBefore(a, ul.firstChild);
                    }
                }



            })
            .catch(error => {
                alert("AI failed to generate a proper response. Try again. No credit deducted");
                console.error(error);
            });
    });

    // Attach event listeners to all sidebar conversation links (for initial page load)
    document.querySelectorAll('.convo-link').forEach(function (link) {
        link.addEventListener('click', function (e) {
            e.preventDefault();
            const convoId = this.getAttribute('data-id');
            fetch(`/conversations/detail/${convoId}/`, {
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Could not load conversation.');
                        return;
                    }
                    document.getElementById('last-reply').value = data.content;
                    document.getElementById('situation').value = data.situation || 'just_matched';
                    document.getElementById('her_info').value = data.her_info || ' ';
                    document.getElementById('suggestedReplyMsg').innerHTML = 'No response has been generated yet';
                    var suggestedReply2 = document.getElementById("suggestedReply2");
                    suggestedReply2.style.display = "none"
                    var suggestedReply3 = document.getElementById("suggestedReply3");
                    suggestedReply3.style.display = "none"
                    document.getElementById('suggestedReplyScore').style.display = "none";

                })
                .catch(() => alert('Failed to load conversation.'));
        });
    });
</script>

<!-- Screenshot ocr -->
<script>
    const fileInput = document.getElementById('formFile').addEventListener('change', function (e) {
        const fileInput = e.target;
        const file = fileInput.files[0];
        if (!file) return;

        // Show spinner/status
        document.getElementById('ocr-status').style.display = 'inline-flex';
        const formData = new FormData();
        formData.append('screenshot', file);

        fetch("/conversations/ocr-screenshot/", {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
            .then(response => response.json())
            .then(data => {

                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                    return;
                }

                document.getElementById('ocr-status').style.display = 'none'; // Hide spinner/status
                if (data.ocr_text) {
                    const lastReply = document.getElementById('last-reply');
                    if (lastReply.value.trim()) {
                        lastReply.value = lastReply.value.trim() + "\n\n" + data.ocr_text;
                    } else {
                        lastReply.value = data.ocr_text;
                    }
                    updateCounter();
                } else {
                    alert(data.error || "Failed to extract text from image.");
                }
                fileInput.value = '';
            })
            .catch(() => {
                document.getElementById('ocr-status').style.display = 'none'; // Hide spinner/status
                alert("Failed to OCR the screenshot.");
                fileInput.value = '';
            });
    });


</script>

<script>
    // Event delegation for delete buttons (works for future elements too)
    document.querySelector('.list-group').addEventListener('click', function (e) {
        if (e.target.closest('.delete-convo-btn')) {
            e.preventDefault();
            const btn = e.target.closest('.delete-convo-btn');
            const convoId = btn.getAttribute('data-id');
            if (!confirm("Are you sure you want to delete this conversation?")) return;

            const formData = new FormData();
            formData.append('id', convoId);

            fetch('/conversations/delete/', {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        // Remove the <a> parent of the button
                        btn.closest('a').remove();
                    } else {
                        alert(data.error || "Failed to delete conversation.");
                    }
                });
        }
    });

</script>

<script>
    function copyToClipboard(elementId, btn) {
        const text = document.getElementById(elementId).innerText;
        navigator.clipboard.writeText(text).then(function () {
            // Show tooltip
            const tooltip = btn.querySelector('.copied-tooltip');
            if (tooltip) {
                tooltip.style.display = 'inline-block';
                setTimeout(() => {
                    tooltip.style.display = 'none';
                }, 1200);
            }
        });
    }

</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);
        const paymentStatus = urlParams.get('status');
        const paymentId = urlParams.get('payment_id');

        if (paymentStatus && paymentId) {
            const toastEl = document.getElementById('paymentToast');
            const toastMessage = document.getElementById('paymentToastMessage');

            if (paymentStatus === 'succeeded') {
                toastEl.classList.remove('bg-danger');
                toastEl.classList.add('bg-success');
                toastMessage.innerHTML = `‚úÖ Payment successful! <br> Credits have been successfully added to your account.`;
            } else {
                toastEl.classList.remove('bg-success');
                toastEl.classList.add('bg-danger');
                toastMessage.innerHTML = `‚ùå Payment failed or incomplete. Please try again.`;
            }

            const toast = new bootstrap.Toast(toastEl);
            toast.show();

            // Clean the URL without reloading
            const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
            window.history.replaceState({}, document.title, cleanUrl);
        }
    });
</script>

<script>
    function updateCounter() {
        const ta = document.getElementById('last-reply');
        const c = document.getElementById('charCount');
        if (ta && c) c.textContent = ta.value.length;
    }

    document.addEventListener('DOMContentLoaded', function () {
        const ta = document.getElementById('last-reply');
        updateCounter(); // initial count on load
        if (ta) {
            ta.addEventListener('input', updateCounter);
            ta.addEventListener('keydown', function (e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    document.getElementById('chatForm').requestSubmit();
                }
            });
        }
    });
</script>


{% endblock %}