{% extends "base.html" %}
{% load static %}

{% block title %}Dead Chat? We Got You. | Reignite{% endblock %}

{% block extra_head %}
<style>
    .list-group-item.active,
    .list-group-item:hover {
        background: #e7f3ff !important;
    }
</style>
{% endblock extra_head %}

{% block content %}
<div class="container px-3">
    <div class="row gy-4 flex-column-reverse flex-lg-row">

        <!-- Sidebar: Conversation List -->
        <div class="col-12 col-lg-3">
            {% if conversations %}
            <ul class="list-group">
                {% for conversation in conversations %}
                <a href="#" class="list-group-item list-group-item-action list-group-item-light convo-link"
                    data-id="{{ conversation.id }}">
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <span>{{ conversation.girl_title }}</span>
                        <button class="btn btn-sm btn-link text-danger delete-convo-btn" data-id="{{ conversation.id }}"
                            title="Delete">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                </a>
                {% endfor %}
            </ul>
            {% endif %}
            <div class="mt-3">
                <a href="{% url 'conversation_home'%}" class="btn btn-outline-dark w-100" role="button">
                    <i class="fa fa-plus me-1"></i>Add a new conversation
                </a>
            </div>
        </div>

        <!-- Main Form -->
        <div class="col-12 col-lg-6">
            <div class="form-container">
                <form id="chatForm" class="rounded-4 shadow-lg bg-white p-4 w-100">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="situation" class="form-label fw-semibold">
                            <i class="fa fa-bullseye me-1 text-primary"></i> What's the situation?
                        </label>
                        <select class="form-select rounded-pill" id="situation" name="situation" required>
                            <option value="stuck_after_reply" selected>She replied, but I don’t know what to say</option>
                            
                            <optgroup label="🟢 Early-Conversation">
                                <option value="just_matched">We just matched</option>
                                <option value="spark_interest">I want to spark her interest</option>
                            </optgroup>
                        
                            <optgroup label="🟡 Mid-Conversation">
                                <option value="stuck_after_reply">She replied, but I don’t know what to say</option>
                                <option value="dry_reply">She gave a dry or one-word reply</option>
                                <option value="she_asked_question">She asked me a question</option>
                                <option value="feels_like_interview">Conversation feels like an interview</option>
                                <option value="sassy_challenge">She is being Sassy / Challenging</option>
                                <option value="spark_deeper_conversation">I want to be sincere / vulnerable</option>
                                <option value="pivot_conversation">Change the topic</option>
                            </optgroup>
                        
                            <optgroup label="🔁 Recovery or Reigniting">
                                <option value="left_on_read">She left me on read</option>
                                <option value="reviving_old_chat">I haven’t talked to her in a while</option>
                                <option value="recovering_after_cringe">I think I said something off</option>
                            </optgroup>
                        
                            <optgroup label="🟣 Late-Conversation">
                                <option value="ask_her_out">Ask her out</option>
                                <option value="switching_platforms">Trying to move to another platform</option>
                            </optgroup>
                        
                        </select>

                    </div>


                    <div class="mb-3" id="her-info-div">
                        <label for="her-info" class="form-label fw-semibold">
                            <i class="fa-solid fa-user-secret me-1 text-secondary"></i> Her Information (optional)
                        </label>
                        <textarea name="her-info" id="her_info" class="form-control" rows="3"
                            placeholder="Add anything that might help — her bio, hobbies, vibe, or her hair style." value=""></textarea>
                        <div class="form-text">
                            Users who add information get 10X responses for their matches.
                        </div>
                    </div>


                    <!-- Title and Screenshot Upload -->
                    <div class="mb-3 p-3 rounded-3" style="background: #f8f9fa;" id="screenshot-upload">
                        <label for="formFile" class="form-label mt-2 fw-semibold">
                            <i class="me-1 text-success"></i> Upload Screenshot
                            <span class="small text-muted">(optional – for instant extracting messages)</span>
                        </label>
                        <input class="form-control rounded-pill mb-2" type="file" id="formFile">

                        <div class="form-text mb-2">
                            Drag & drop a chat screenshot, or paste your convo below.
                        </div>
                        <div id="ocr-status" class="mt-2" style="display:none;">
                            <span class="spinner-border spinner-border-sm align-middle text-primary"
                                role="status"></span>
                            <span class="ms-2 text-muted">Analyzing screenshot...</span>
                        </div>
                    </div>

                    <!-- Conversation Paste Area -->
                    <div class="mb-3" id="conversation-paste-area">
                        <label for="last-reply" class="form-label fw-semibold">
                            <i class="me-1 text-warning"></i> Conversation
                        </label>
                        <textarea name="last-reply" id="last-reply" class="form-control" style="min-height:120px"
                            placeholder="you: hey, free thursday?&#10;her: (seen, no reply)" rows="5"></textarea>
                        <div class="form-text text-end"><span id="charCount">0</span> characters</div>
                    </div>

                    <!-- Submit -->
                    <div class="d-flex justify-content-between align-items-center" id="submit-area">
                        <button type="submit" class="btn btn-dark btn-lg px-4 rounded-pill shadow-sm" id="generate-btn">
                            <i class="fa fa-fire me-2"></i>Generate Reply
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Suggested Responses -->
        <div class="col-12 col-lg-3 text-center" id="responseArea">
            <p>Suggested Responses</p>

            <div id="suggestedReply" class="p-4 bg-light rounded-4 shadow w-100 position-relative mb-3">
                <button type="button" class="btn btn-link btn-sm position-absolute top-0 end-0 m-2 copy-btn"
                    onclick="copyToClipboard('suggestedReplyMsg', this)" title="Copy to clipboard">
                    <i class="fa fa-copy"></i>
                    <span class="copied-tooltip"
                        style="display: none; position: absolute; top: 120%; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 2px 8px; border-radius: 8px; font-size: 12px; z-index: 2;">Copied!</span>
                </button>
                <span id="suggestedReplyMsg">No response has been generated yet</span><br>
                <span class="small text-muted" id="suggestedReplyScore"></span>
            </div>

            <div id="suggestedReply2" class="p-4 bg-light rounded-4 shadow w-100 position-relative mb-3"
                style="display: none;">
                <button type="button" class="btn btn-link btn-sm position-absolute top-0 end-0 m-2 copy-btn"
                    onclick="copyToClipboard('suggestedReplyMsg2', this)" title="Copy to clipboard">
                    <i class="fa fa-copy"></i>
                    <span class="copied-tooltip"
                        style="display: none; position: absolute; top: 120%; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 2px 8px; border-radius: 8px; font-size: 12px; z-index: 2;">Copied!</span>
                </button>
                <span id="suggestedReplyMsg2">No response has been generated yet</span><br>
                <span class="small text-muted" id="suggestedReplyScore2"></span>
            </div>

            <div id="suggestedReply3" class="p-4 bg-light rounded-4 shadow w-100 position-relative mb-3"
                style="display: none;">
                <button type="button" class="btn btn-link btn-sm position-absolute top-0 end-0 m-2 copy-btn"
                    onclick="copyToClipboard('suggestedReplyMsg3', this)" title="Copy to clipboard">
                    <i class="fa fa-copy"></i>
                    <span class="copied-tooltip"
                        style="display: none; position: absolute; top: 120%; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 2px 8px; border-radius: 8px; font-size: 12px; z-index: 2;">Copied!</span>
                </button>
                <span id="suggestedReplyMsg3">No response has been generated yet</span><br>
                <span class="small text-muted" id="suggestedReplyScore3"></span>
            </div>
        </div>
    </div>
</div>
<!-- Payment Toast Notification -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1055">
    <div id="paymentToast" class="toast align-items-center text-white bg-success border-0" role="alert"
        aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="paymentToastMessage">
                Payment succeeded!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Close"></button>
        </div>
    </div>
</div>


<!-- JS -->

<script>
    const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]')?.value || '';
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('chatForm');
        const generateBtn = document.getElementById('generate-btn') || form.querySelector('button[type="submit"]');

        // Cards & fields
        const responseArea = document.getElementById('responseArea');
        const card1 = document.getElementById('suggestedReply');
        const card2 = document.getElementById('suggestedReply2');
        const card3 = document.getElementById('suggestedReply3');
        const msg1 = document.getElementById('suggestedReplyMsg');
        const score1 = document.getElementById('suggestedReplyScore');
        const msg2 = document.getElementById('suggestedReplyMsg2');
        const score2 = document.getElementById('suggestedReplyScore2');
        const msg3 = document.getElementById('suggestedReplyMsg3');
        const score3 = document.getElementById('suggestedReplyScore3');

        form.addEventListener('submit', function (e) {
            e.preventDefault();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            // Disable button + spinner
            const oldBtnHTML = generateBtn ? generateBtn.innerHTML : '';
            if (generateBtn) {
                generateBtn.disabled = true;
                generateBtn.setAttribute('aria-busy', 'true');
                generateBtn.innerHTML = `<span class="spinner-border spinner-border-sm align-middle" role="status"></span>
                                 <span class="ms-2">Generating…</span>`;
            }

            // Immediately show ONLY card #1 with “Generating…”
            if (card1) card1.style.display = 'block';
            if (card2) card2.style.display = 'none';
            if (card3) card3.style.display = 'none';
            if (msg1) {
                msg1.innerHTML = `
          <span class="spinner-border spinner-border-sm align-middle text-primary" role="status"></span>
          <span class="ms-2 text-muted">Generating your texts…</span>
        `;
            }
            if (score1) score1.innerText = '';

            const payload = {
                last_text: document.getElementById('last-reply')?.value || '',
                situation: document.getElementById('situation')?.value || '',
                her_info: document.getElementById('her_info')?.value || ''
            };

            fetch("{% url 'ajax_reply' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify(payload)
            })
                .then(async (response) => {
                    const data = await response.json().catch(() => null);

                    if (data && data.redirect_url) { // out-of-credits path
                        window.location.href = data.redirect_url;
                        throw 'redirected';
                    }

                    if (!response.ok || (data && data.error)) {
                        const msg = (data && data.error) ? data.error : `Error ${response.status}`;
                        throw new Error(msg);
                    }
                    return data;
                })
                .then((data) => {
                    // Parse the AI suggestions from data.custom safely
                    let custom = data.custom;
                    if (typeof custom !== 'string') throw new Error('Unexpected response format from server.');
                    custom = custom.replace(/^json\s*/i, '').trim();
                    if (!custom.startsWith('[')) { const m = custom.match(/\[.*\]/s); if (m) custom = m[0]; }

                    let suggestions;
                    try { suggestions = JSON.parse(custom); }
                    catch (e) { throw new Error('Could not parse AI response. ' + e.message); }

                    // Show ALL 3 cards (fill placeholders if missing)
                    if (responseArea) responseArea.style.display = 'block';
                    card1.style.display = 'block';
                    card2.style.display = 'block';
                    card3.style.display = 'block';

                    const s1 = suggestions?.[0] || {};
                    const s2 = suggestions?.[1] || {};
                    const s3 = suggestions?.[2] || {};

                    msg1.innerText = s1.message || '—';
                    score1.innerText = (typeof s1.confidence_score === 'number') ? `Confidence: ${Math.round(s1.confidence_score * 100)}%` : '';

                    msg2.innerText = s2.message || '—';
                    score2.innerText = (typeof s2.confidence_score === 'number') ? `Confidence: ${Math.round(s2.confidence_score * 100)}%` : '';

                    msg3.innerText = s3.message || '—';
                    score3.innerText = (typeof s3.confidence_score === 'number') ? `Confidence: ${Math.round(s3.confidence_score * 100)}%` : '';

                    if (typeof data.credits_left !== 'undefined') {
                        const creditsEl = document.getElementById('chatCredits');
                        if (creditsEl) creditsEl.innerText = data.credits_left;
                    }
                })
                .catch((err) => {
                    if (err === 'redirected') return;
                    alert(err?.message || 'Error generating reply.');

                    // Revert to “idle” in card #1
                    if (msg1) msg1.innerText = 'No response has been generated yet';
                    if (score1) score1.innerText = '';
                    if (card2) card2.style.display = 'none';
                    if (card3) card3.style.display = 'none';
                })
                .finally(() => {
                    if (generateBtn) {
                        generateBtn.disabled = false;
                        generateBtn.removeAttribute('aria-busy');
                        generateBtn.innerHTML = oldBtnHTML;
                    }
                });
        });
    });



    
    // Attach event listeners to all sidebar conversation links (for initial page load)
    document.querySelectorAll('.convo-link').forEach(function (link) {
        link.addEventListener('click', function (e) {
            e.preventDefault();
            const convoId = this.getAttribute('data-id');
            fetch(`/conversations/detail/${convoId}/`, {
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Could not load conversation.');
                        return;
                    }
                    document.getElementById('last-reply').value = data.content;
                    document.getElementById('situation').value = data.situation || 'just_matched';
                    document.getElementById('her_info').value = data.her_info || ' ';
                    document.getElementById('suggestedReplyMsg').innerHTML = 'No response has been generated yet';
                    var suggestedReply2 = document.getElementById("suggestedReply2");
                    suggestedReply2.style.display = "none"
                    var suggestedReply3 = document.getElementById("suggestedReply3");
                    suggestedReply3.style.display = "none"
                    document.getElementById('suggestedReplyScore').style.display = "none";

                })
                .catch(() => alert('Failed to load conversation.'));
        });
    });
</script>

<!-- Screenshot ocr -->
<script>
    const fileInput = document.getElementById('formFile').addEventListener('change', function (e) {
        const fileInput = e.target;
        const file = fileInput.files[0];
        if (!file) return;

        // Show spinner/status
        document.getElementById('ocr-status').style.display = 'inline-flex';
        const formData = new FormData();
        formData.append('screenshot', file);

        fetch("/conversations/ocr-screenshot/", {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
            .then(response => response.json())
            .then(data => {

                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                    return;
                }

                document.getElementById('ocr-status').style.display = 'none'; // Hide spinner/status
                if (data.ocr_text) {
                    const lastReply = document.getElementById('last-reply');
                    if (lastReply.value.trim()) {
                        lastReply.value = lastReply.value.trim() + "\n\n" + data.ocr_text;
                    } else {
                        lastReply.value = data.ocr_text;
                    }
                    updateCounter();
                } else {
                    alert(data.error || "Failed to extract text from image.");
                }
                fileInput.value = '';
            })
            .catch(() => {
                document.getElementById('ocr-status').style.display = 'none'; // Hide spinner/status
                alert("Failed to OCR the screenshot.");
                fileInput.value = '';
            });
    });


</script>

<script>
    // Event delegation for delete buttons (works for future elements too)
    document.querySelector('.list-group').addEventListener('click', function (e) {
        if (e.target.closest('.delete-convo-btn')) {
            e.preventDefault();
            const btn = e.target.closest('.delete-convo-btn');
            const convoId = btn.getAttribute('data-id');
            if (!confirm("Are you sure you want to delete this conversation?")) return;

            const formData = new FormData();
            formData.append('id', convoId);

            fetch('/conversations/delete/', {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        // Remove the <a> parent of the button
                        btn.closest('a').remove();
                    } else {
                        alert(data.error || "Failed to delete conversation.");
                    }
                });
        }
    });

</script>

<script>
    function copyToClipboard(elementId, btn) {
        const text = document.getElementById(elementId).innerText;
        navigator.clipboard.writeText(text).then(function () {
            // Show tooltip
            const tooltip = btn.querySelector('.copied-tooltip');
            if (tooltip) {
                tooltip.style.display = 'inline-block';
                setTimeout(() => {
                    tooltip.style.display = 'none';
                }, 1200);
            }
        });
    }

</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);
        const paymentStatus = urlParams.get('status');
        const paymentId = urlParams.get('payment_id');

        if (paymentStatus && paymentId) {
            const toastEl = document.getElementById('paymentToast');
            const toastMessage = document.getElementById('paymentToastMessage');

            if (paymentStatus === 'succeeded') {
                toastEl.classList.remove('bg-danger');
                toastEl.classList.add('bg-success');
                toastMessage.innerHTML = `✅ Payment successful! <br> Credits have been successfully added to your account.`;
            } else {
                toastEl.classList.remove('bg-success');
                toastEl.classList.add('bg-danger');
                toastMessage.innerHTML = `❌ Payment failed or incomplete. Please try again.`;
            }

            const toast = new bootstrap.Toast(toastEl);
            toast.show();

            // Clean the URL without reloading
            const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
            window.history.replaceState({}, document.title, cleanUrl);
        }
    });
</script>

<script>
    function updateCounter() {
        const ta = document.getElementById('last-reply');
        const c = document.getElementById('charCount');
        if (ta && c) c.textContent = ta.value.length;
    }

    document.addEventListener('DOMContentLoaded', function () {
        const ta = document.getElementById('last-reply');
        updateCounter(); // initial count on load
        if (ta) {
            ta.addEventListener('input', updateCounter);
            ta.addEventListener('keydown', function (e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    document.getElementById('chatForm').requestSubmit();
                }
            });
        }
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const situationSelect = document.getElementById('situation');
        const herInfoDiv = document.getElementById('her-info-div');

        // Hide by default
        herInfoDiv.style.display = 'none';

        // Function to toggle visibility
        function toggleHerInfo() {
            const val = situationSelect.value;
            if (val === 'just_matched' || val === 'spark_interest') {
                herInfoDiv.style.display = 'block';
            } else {
                herInfoDiv.style.display = 'none';
            }
        }

        // Initial check
        toggleHerInfo();

        // Listen for changes
        situationSelect.addEventListener('change', toggleHerInfo);
    });
</script>



{% endblock %}